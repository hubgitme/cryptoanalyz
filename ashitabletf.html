<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>تحلیل چند تایم‌فریم - Heikin Ashi</title>
<style>
	
body { background:#111; color:#eee; font-family:sans-serif; padding:12px; text-align:center; }
h1 { color:#00ff99; font-size:16px; margin-bottom:10px; }
.table-container { overflow-x:auto; margin-top:10px; }
table { width:100%; border-collapse:collapse; min-width:1600px; font-size:12px; }
th, td { border:1px solid #333; padding:4px; text-align:center; white-space:nowrap; }
th { background:#1c1c1c; color:#0ff; font-weight:bold; }

.buy { color:#0f0; font-weight:bold; }
.sell { color:#f33; font-weight:bold; }
.neutral { color:#ccc; font-weight:bold; }
.tick.green { color:#0f0; font-weight:bold; }
.tick.red { color:#f33; font-weight:bold; }
.ema20 { color:#0ff; }
.ema50 { color:#33ffcc; }
.ema100 { color:#66ff66; }
.ma200 { color:#ff9900; }
.rsi { color:#ab47bc; }
.cci { color:#089981; }
.roc { color:#2962FF; }
.macd { color:#2962FF; }
.macdSignal { color:#FF6D00; }
.macdHist { color:#ff00ff; }
.tenkan { color:#2962ff; }
.kijun { color:#b71c1c; }
.senkouA { color:#a5d6a7; }
.senkouB { color:#ef9a9a; }
.chikou { color:#ffa726; }
.senkouAC { color:#a5d6a7; }
.senkouBC { color:#ef9a9a; }
.bollUpper, .bollMid, .bollLower { color:#dbdbdb; }

tbody tr:nth-child(odd) { background-color: #3b3b3b; }  /* خاکستری تیره */
tbody tr:nth-child(even) { background-color: #2a2a2a; } /* خاکستری روشن‌تر */

a.tv { color:#0ff; text-decoration:none; }
</style>
</head>
<body>
<h1>تحلیل زنده چند تایم‌فریم - Heikin Ashi
 (آپدیت هر 30 ثانیه)         
</h1>

	<!-- لینک برگشت به صفحه اصلی -->
<div id="homeLink" style="margin: 20px; text-align: center;">
  <a href="index.html" 
     style="color:#0ff; font-size:16px; font-weight:bold; text-decoration:none;">
برگشت به صفحه اصلی
</a>
</div>
<label for="symbolSelect">انتخاب ارز:</label>
<select id="symbolSelect">
  <option selected>BLUMUSDT</option>
  <option >BTCUSDT</option>
  <option>ETHUSDT</option>
  <option>SOLUSDT</option>
  <option>SUIUSDT</option>
  <option>XRPUSDT</option>
  <option>NEARUSDT</option>
  <option>CAKEUSDT</option>
    <option>ASTERUSDT</option>
  <option>ADAUSDT</option>
  <option>CRVUSDT</option>
  <option>XLMUSDT</option>
  <option>DOGEUSDT</option>
  <option>TRXUSDT</option>
  <option>PENGUUSDT</option>
  <option>ESXUSDT</option>
  <option>PUMPUSDT</option>
  <option>MEMEFIUSDT</option>
  <option>PEPEUSDT</option>
  <option>MAJORUSDT</option>
  <option>TONUSDT</option>
</select>

<div class="table-container">
<table>
<thead>
<tr>
<th>تایم‌فریم</th>
<th>قیمت</th>
<th>BB Mid</th>
<th>EMA20</th>
<th>EMA50</th>
<th>EMA100</th>
<th>MA200</th>
<th>BB Upper</th>
<th>BB Lower</th>
<th>RSI</th>
<th>RSI MA</th>
<th>CCI</th>
<th>CCI MA</th>
<th>ROC</th>
<th>ROC MA</th>
<th>MACD</th>
<th>Signal</th>
<th>Hist</th>
<th>Tenkan</th>
<th>Kijun</th>
<th>SenkouAC</th>
<th>SenkouBC</th>
<th>SenkouA</th>
<th>SenkouB</th>
<th>سیگنال</th>
<th>TV</th>
</tr>
</thead>
<tbody id="tableBody">
  <tr><td colspan="27">در حال دریافت داده‌ها...</td></tr>
</tbody>
</table>
</div>

<script>
// ==== تنظیمات ====
const symbols =[ "BLUMUSDT","BTCUSDT","ETHUSDT","SOLUSDT","SUIUSDT","XRPUSDT","NEARUSDT","CAKEUSDT","ASTERUSDT","ADAUSDT","CRVUSDT","XLMUSDT","DOGEUSDT","TRXUSDT","PENGUUSDT","ESXUSDT","PUMPUSDT","MEMEFIUSDT","PEPEUSDT","MAJORUSDT","TONUSDT"];
const intervals = ["15m","30m","60m","4h","1d"];
let currentSymbol = document.getElementById('symbolSelect').value;

// ==== تابع دریافت داده از MEXC ====
async function fetchPrices(symbol, interval="60m"){
  try{
    const url=`https://api.mexc.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=200`;
    const proxy="https://corsproxy.io/?";
    const res=await fetch(proxy+encodeURIComponent(url));
    const data=await res.json();
    return data.map(c=>({time:new Date(c[0]), open:+c[1], high:+c[2], low:+c[3], close:+c[4]}));
  }catch(e){ console.error(e); return null; }
}

// ==== محاسبه HA ====
function convertHA(data){
  if(!data) return [];
  const ha=[];
  for(let i=0;i<data.length;i++){
    const {open:o,high:h,low:l,close:c}=data[i];
    if(i===0) ha.push({open:(o+c)/2, high:h, low:l, close:(o+h+l+c)/4});
    else{
      const prev=ha[i-1];
      const haClose=(o+h+l+c)/4;
      ha.push({open:(prev.open+prev.close)/2, high:Math.max(h,(prev.open+prev.close)/2,haClose), low:Math.min(l,(prev.open+prev.close)/2,haClose), close:haClose});
    }
  }
  return ha;
}

// ==== EMA, MA, RSI, CCI, ROC, Bollinger, MACD, Ichimoku ====
function calculateEMAArray(values, period){
  if(!values||values.length<period) return Array(values?values.length:0).fill(null);
  const k=2/(period+1), out=[]; let sum=0;
  for(let i=0;i<values.length;i++){
    const v=values[i];
    if(i<period-1){ out.push(null); sum+=v||0; continue; }
    if(i===period-1){ sum+=v||0; out.push(sum/period); continue; }
    const prev=out[i-1]; const val=v==null?prev:v; out.push(val*k + prev*(1-k));
  }
  return out;
}

function calculateMA(values, period){
  if(!values || values.length<period) return [];
  const ma=[];
  for(let i=0;i<values.length;i++){
    if(i<period-1||values[i]==null) ma.push(null);
    else { const slice=values.slice(i-period+1,i+1).filter(v=>v!=null); ma.push(slice.reduce((a,b)=>a+b,0)/slice.length); }
  }
  return ma;
}

function calculateRSI(data, period=14) {
  const closes = data.map(d=>d.close);
  if (closes.length <= period) return Array(closes.length).fill(null);

  let gains = 0, losses = 0;
  for (let i=1; i<=period; i++) {
    const diff = closes[i] - closes[i-1];
    if (diff >= 0) gains += diff;
    else losses -= diff;
  }
  let avgGain = gains / period;
  let avgLoss = losses / period;

  const rsi = Array(period).fill(null);
  for (let i=period; i<closes.length; i++) {
    if (i > period) {
      const diff = closes[i] - closes[i-1];
      if (diff >= 0) {
        avgGain = (avgGain*(period-1)+diff)/period;
        avgLoss = (avgLoss*(period-1)+0)/period;
      } else {
        avgGain = (avgGain*(period-1)+0)/period;
        avgLoss = (avgLoss*(period-1)+(-diff))/period;
      }
    }
    const rs = avgLoss === 0 ? 100 : avgGain/avgLoss;
    rsi.push(100 - (100/(1+rs)));
  }
  return rsi;
}

function calculateCCI(data, period=14) {
  if (!data || data.length < period) return Array(data.length).fill(null);
  const cci = [];

  for (let i=0; i<data.length; i++) {
    if (i < period-1) {
      cci.push(null);
      continue;
    }
    const slice = data.slice(i-period+1, i+1);
    const tp = slice.map(d=>(d.high+d.low+d.close)/3);
    const sma = tp.reduce((a,b)=>a+b,0)/period;
    const meanDev = tp.reduce((a,b)=>a+Math.abs(b-sma),0)/period;
    const currentTP = (data[i].high+data[i].low+data[i].close)/3;
    cci.push((currentTP - sma) / (0.015*meanDev));
  }
  return cci;
}

function calculateBollinger(data, period=14){
  if(!data || data.length<period) return {upper:[], mid:[], lower:[]};
  const mid=[]; for(let i=period-1;i<data.length;i++){ const slice=data.slice(i-period+1,i+1).map(d=>d.close); mid.push(slice.reduce((a,b)=>a+b,0)/period); }
  const upper=[], lower=[];
  for(let i=period-1;i<data.length;i++){
    const slice=data.slice(i-period+1,i+1).map(d=>d.close);
    const avg=mid[i-(period-1)];
    const std=Math.sqrt(slice.map(p=>Math.pow(p-avg,2)).reduce((a,b)=>a+b,0)/period);
    upper.push(avg+2*std); lower.push(avg-2*std);
  }
  return {upper, mid, lower};
}

// ==== MACD ====
function calculateMACD(prices, fast=12, slow=26, signal=9){
  const closeArray = prices.map(p=>p.close);
  const emaFast = calculateEMAArray(closeArray, fast);
  const emaSlow = calculateEMAArray(closeArray, slow);
  const macdLine = emaFast.map((v,i)=>(v==null||emaSlow[i]==null)?null:(v-emaSlow[i]));
  const signalLine = calculateEMAArray(macdLine, signal);
  const histogram = macdLine.map((v,i)=>(v==null||signalLine[i]==null)?null:(v-signalLine[i]));
  return {macdLine, signalLine, histogram};
}

// ==== ROC ====
function calculateROC(prices, period=9){
  if(!prices || prices.length<period) return [];
  return prices.map((p,i)=> i<period ? null : (p.close - prices[i-period].close)/prices[i-period].close*100);
}

// ==== Ichimoku ====
function calculateIchimoku(data){
  if(!data || data.length<52) return {tenkan:[], kijun:[], senkouA:[], senkouB:[], chikou:[]};
  const tenkan=[], kijun=[], senkouA=[], senkouB=[], chikou=[];
  for(let i=0;i<data.length;i++){
    tenkan.push(i>=8 ? (Math.max(...data.slice(i-8,i+1).map(d=>d.high))+Math.min(...data.slice(i-8,i+1).map(d=>d.low)))/2 : null);
    kijun.push(i>=25 ? (Math.max(...data.slice(i-25,i+1).map(d=>d.high))+Math.min(...data.slice(i-25,i+1).map(d=>d.low)))/2 : null);
    senkouA.push(i>=25 ? (tenkan[i]+kijun[i])/2 : null);
    senkouB.push(i>=51 ? (Math.max(...data.slice(i-51,i+1).map(d=>d.high))+Math.min(...data.slice(i-51,i+1).map(d=>d.low)))/2 : null);
    chikou.push(i>=26 ? data[i-26].close : null);
  }
  return {tenkan,kijun,senkouA,senkouB,chikou};
}

// ==== Tick سبز/قرمز ====
function getTickHtml(cond){ return cond?'<span class="tick green">✔</span>':'<span class="tick red">✘</span>'; }

// ==== دریافت داده و محاسبه اندیکاتورها ====
async function getSymbolData(symbol, interval){
  const raw = await fetchPrices(symbol, interval);
  if(!raw || raw.length === 0){
    console.warn("داده‌ای دریافت نشد");
    return null;
  }

  const ha = convertHA(raw);
  const price = raw[raw.length-1].close;

  // EMAها
  const ema20 = ha.length >= 20 ? calculateEMAArray(ha.map(d=>d.close),20) : Array(ha.length).fill(null);
  const ema50 = ha.length >= 50 ? calculateEMAArray(ha.map(d=>d.close),50) : Array(ha.length).fill(null);
  const ema100 = ha.length >= 100 ? calculateEMAArray(ha.map(d=>d.close),100) : Array(ha.length).fill(null);
  const ma200 = ha.length >= 200 ? calculateMA(ha.map(d=>d.close),200) : Array(ha.length).fill(null);

  // Bollinger
  const boll = ha.length >= 14 ? calculateBollinger(ha) : {upper:Array(ha.length).fill(null), mid:Array(ha.length).fill(null), lower:Array(ha.length).fill(null)};

  // RSI و CCI
  const rsi = ha.length >= 14 ? calculateRSI(ha) : Array(ha.length).fill(null);
  const rsiMA = rsi.length >= 14 ? calculateMA(rsi,14) : Array(rsi.length).fill(null);
  const cci = ha.length >= 14 ? calculateCCI(ha) : Array(ha.length).fill(null);
  const cciMA = cci.length >= 14 ? calculateMA(cci,14) : Array(cci.length).fill(null);

  // ROC
  const roc = ha.length >= 9 ? calculateROC(ha,9) : Array(ha.length).fill(null);
  const rocMA = roc.length >= 5 ? calculateMA(roc,5) : Array(roc.length).fill(null);

  // MACD
  const macd = ha.length >= 26 ? calculateMACD(ha) : {macdLine:Array(ha.length).fill(null), signalLine:Array(ha.length).fill(null), histogram:Array(ha.length).fill(null)};

  // Ichimoku
  const ichimoku = ha.length >= 52 ? calculateIchimoku(ha) : {tenkan:Array(ha.length).fill(null), kijun:Array(ha.length).fill(null), senkouA:Array(ha.length).fill(null), senkouB:Array(ha.length).fill(null), chikou:Array(ha.length).fill(null)};

  const prevcci = cci.length >= 2 ? cci.at(-2) : null;

  const latest = {
    ema20: ema20.at(-1), ema50: ema50.at(-1), ema100: ema100.at(-1),
    ma200: ma200.at(-1),
    bollUpper: boll.upper.at(-1), bollMid: boll.mid.at(-1), bollLower: boll.lower.at(-1),
    rsi: rsi.at(-1), rsiMA: rsiMA.at(-1),
    cci: cci.at(-1), cciMA: cciMA.at(-1),
    macd: macd.macdLine.at(-1), macdSignal: macd.signalLine.at(-1), macdHist: macd.histogram.at(-1),
    roc: roc.at(-1), rocMA: rocMA.at(-1),
    tenkan: ichimoku.tenkan.at(-1), kijun: ichimoku.kijun.at(-1),
    senkouAc: ichimoku.senkouA.at(-25) ?? null,
    senkouBc: ichimoku.senkouB.at(-25) ?? null,
    senkouA: ichimoku.senkouA.at(-1), senkouB: ichimoku.senkouB.at(-1),
    chikou: ichimoku.chikou.at(-1)
  };

  // سیگنال خرید/فروش
  let buy=false, sell=false;
  if([price, latest.ema20, latest.bollMid, latest.rsi, latest.rsiMA, latest.cci].every(v=>v!=null)){
    buy = price>latest.ema20 && price>latest.bollMid && latest.rsi>latest.rsiMA && prevcci<0 && latest.cci>0;
    sell = price<latest.ema20 && price<latest.bollMid && latest.rsi<latest.rsiMA && prevcci>0 && latest.cci<0;
  }

  return {...latest, symbol, price, buySignal:buy, sellSignal:sell};
}

/* ===== تابع ساخت سطرها برای نماد فعلی (یک‌بار) ===== */
function buildRowsForSymbol(symbol){
  const tbody = document.getElementById('tableBody');
  tbody.innerHTML = ''; // پاک‌سازی placeholder یا سطرهای قبلی
  for(const interval of intervals){
    const tr = document.createElement('tr');
    tr.id = `${symbol}_${interval}`;
    tr.innerHTML = `
      <td class="interval">${interval}</td>
      <td class="price">—</td>
      <td class="bollMid">—</td>
      <td class="ema20">—</td>
      <td class="ema50">—</td>
      <td class="ema100">—</td>
      <td class="ma200">—</td>
      <td class="bollUpper">—</td>
      <td class="bollLower">—</td>
      <td class="rsi">—</td>
      <td class="rsiMA">—</td>
      <td class="cci">—</td>
      <td class="cciMA">—</td>
      <td class="roc">—</td>
      <td class="rocMA">—</td>
      <td class="macd">—</td>
      <td class="macdSignal">—</td>
      <td class="macdHist">—</td>
      <td class="tenkan">—</td>
      <td class="kijun">—</td>
      <td class="senkouAC">—</td>
      <td class="senkouBC">—</td>
      <td class="senkouA">—</td>
      <td class="senkouB">—</td>
      <td class="signal neutral">خنثی</td>
      <td class="tv"><a class="tv" href="https://www.tradingview.com/chart/?symbol=BINANCE:${symbol}" target="_blank">مشاهده</a></td>
    `;
    tbody.appendChild(tr);
  }
}

/* ===== بروزرسانی فقط مقادیر سلول‌ها ===== */
async function updateAll(){
  for(const interval of intervals){
    try{
      const data = await getSymbolData(currentSymbol, interval);
      const rowId = `${currentSymbol}_${interval}`;
      let row = document.getElementById(rowId);
      if(!row){
        // اگر به هر دلیلی هنوز row نیست، بساز و سپس ادامه بده
        buildRowsForSymbol(currentSymbol);
        row = document.getElementById(rowId);
      }

      if(!data){
        // خطا در گرفتن دیتا — فقط سلول سیگنال و قیمت را آپدیت کن
        if(row){
          row.querySelector('.price').textContent = '—';
          const sig = row.querySelector('.signal');
          sig.className = 'signal neutral';
          sig.textContent = 'خطا';
        }
        continue;
      }

      // آپدیت مقادیر سلول‌ها
      row.querySelector('.price').textContent = data.price?.toFixed(5) ?? '—';
      row.querySelector('.bollMid').innerHTML = `${data.bollMid?.toFixed(5) ?? '—'} ${getTickHtml(data.price>data.bollMid)}`;
      row.querySelector('.ema20').innerHTML = `${data.ema20?.toFixed(5) ?? '—'} ${getTickHtml(data.price>data.ema20)}`;
      row.querySelector('.ema50').innerHTML = `${data.ema50?.toFixed(5) ?? '—'} ${getTickHtml(data.price>data.ema50)}`;
      row.querySelector('.ema100').innerHTML = `${data.ema100?.toFixed(5) ?? '—'} ${getTickHtml(data.price>data.ema100)}`;
      row.querySelector('.ma200').innerHTML = `${data.ma200?.toFixed(5) ?? '—'} ${getTickHtml(data.price>data.ma200)}`;
      row.querySelector('.bollUpper').textContent = data.bollUpper?.toFixed(5) ?? '—';
      row.querySelector('.bollLower').textContent = data.bollLower?.toFixed(5) ?? '—';
      row.querySelector('.rsi').innerHTML = `${data.rsi?.toFixed(2) ?? '—'} ${getTickHtml(data.rsi>data.rsiMA)}`;
      row.querySelector('.rsiMA').textContent = data.rsiMA?.toFixed(2) ?? '—';
      row.querySelector('.cci').innerHTML = `${data.cci?.toFixed(2) ?? '—'} ${getTickHtml(data.cci>0)}`;
      row.querySelector('.cciMA').textContent = data.cciMA?.toFixed(2) ?? '—';
      row.querySelector('.roc').innerHTML = `${data.roc?.toFixed(2) ?? '—'} ${getTickHtml(data.roc>data.rocMA)}`;
      row.querySelector('.rocMA').textContent = data.rocMA?.toFixed(2) ?? '—';
      row.querySelector('.macd').innerHTML = `${data.macd?.toFixed(5) ?? '—'} ${getTickHtml(data.macd>data.macdSignal)}`;
      row.querySelector('.macdSignal').textContent = data.macdSignal?.toFixed(5) ?? '—';
      row.querySelector('.macdHist').innerHTML = `${data.macdHist?.toFixed(5) ?? '—'} ${getTickHtml(data.macdHist>0)}`;
      row.querySelector('.tenkan').innerHTML = `${data.tenkan?.toFixed(4) ?? '—'} ${getTickHtml(data.tenkan>data.kijun)}`;
      row.querySelector('.kijun').textContent = data.kijun?.toFixed(4) ?? '—';
      row.querySelector('.senkouAC').textContent = data.senkouAc?.toFixed(4) ?? '—';
      row.querySelector('.senkouBC').textContent = data.senkouBc?.toFixed(4) ?? '—';
      row.querySelector('.senkouA').innerHTML = `${data.senkouA?.toFixed(4) ?? '—'} ${getTickHtml(data.senkouA>data.senkouB)}`;
      row.querySelector('.senkouB').textContent = data.senkouB?.toFixed(4) ?? '—';

      const sig = row.querySelector('.signal');
      sig.className = 'signal ' + (data.buySignal ? 'buy' : data.sellSignal ? 'sell' : 'neutral');
      sig.textContent = data.buySignal ? 'خرید ✅' : data.sellSignal ? 'فروش ❌' : 'خنثی';

      // به‌روز کردن لینک TV اگر لازم باشه (نماد ممکنه تغییر نکرده باشه)
      const tv = row.querySelector('.tv a');
      if(tv && tv.href.indexOf(currentSymbol) === -1){
        tv.href = `https://www.tradingview.com/chart/?symbol=BINANCE:${currentSymbol}`;
      }

    }catch(err){
      console.error('خطا در آپدیت', interval, err);
      const row = document.getElementById(`${currentSymbol}_${interval}`);
      if(row){
        const sig = row.querySelector('.signal');
        sig.className = 'signal neutral';
        sig.textContent = 'خطا';
      }
    }
  }
}

/* ==== وقتی select تغییر کرد جدول را دوباره بساز و آپدیت کن ==== */
document.getElementById('symbolSelect').addEventListener('change', e=>{
  currentSymbol = e.target.value;
  buildRowsForSymbol(currentSymbol);
  updateAll();
});

/* ==== اجرای اولیه و زمان‌بندی آپدیت ==== */
buildRowsForSymbol(currentSymbol);
updateAll();
setInterval(updateAll, 30000);
</script>
</body>
</html>
