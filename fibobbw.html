<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>تحلیل زنده و فیبوناچی (با هشدار کراس باند میانی)</title>
<style>
body { background:#111; color:#eee; font-family:sans-serif; padding:12px; text-align:center; }
h1,h2 { color:#00ff99; margin-bottom:10px; font-size:12px;}
.table-container { overflow-x:auto; margin-top:10px; }
table { border-collapse:collapse; min-width:100%; font-size:12px; margin-bottom:30px; }
th, td { border:1px solid #333; padding:4px; text-align:center; white-space:nowrap; }
th { background:#1c1c1c; color:#0ff; font-weight:bold; }

.buy { color:#0f0; font-weight:bold; }
.sell { color:#f33; font-weight:bold; }
.neutral { color:#ccc; font-weight:bold; }
.tick.green { color:#0f0; font-weight:bold; }
.tick.red { color:#f33; font-weight:bold; }

.rsi { color:#ab47bc; }
.cci { color:#089981; }
.roc { color:#2962FF; }
.ema7 { color:#2962FF; }
.bollUpper, .bollMid, .bollLower { color:#dbdbdb; }

table tbody td:nth-child(odd):not(:first-child) { background-color: #3b3b3b; }
table tbody td:nth-child(even):not(:first-child) { background-color: #2a2a2a; }

a.tv { color:#0ff; text-decoration:none; }
select, button { background: #222; color: white; border: 1px solid #555; border-radius:6px; padding:6px; margin:4px; cursor:pointer;}
button { background:#0078ff; border:none; }
button:hover { background:#005ad1; }

/* استایل جدید برای دکمه‌های تایم‌فریم فیبوناچی */
.fibo-tf-selector button {
    background: #2a2a2a;
    color: #0ff;
    border: 1px solid #0ff;
    margin: 4px 6px;
    padding: 8px 10px;
}
.fibo-tf-selector button.active {
    background: #0078ff;
    color: white;
    border-color: #0078ff;
}
</style>
</head>
<body>

<h1>تحلیل زنده چند تایم‌فریم + فیبوناچی</h1>

<!-- لینک برگشت به صفحه اصلی -->
<div id="homeLink" style="margin: 20px; text-align: center;">
  <a href="index.html" 
     style="color:#0ff; font-size:16px; font-weight:bold; text-decoration:none;">
برگشت به صفحه اصلی
</a>
</div>

<p id="crossoverStatus" style="margin-top:15px; font-weight:bold; font-size:14px;">
    ✅ در حال نظارت بر کراس باند میانی بولینگر.
</p>

<label for="symbolSelect">انتخاب ارز:</label>
<select id="symbolSelect">
  <option selected>BLUMUSDT</option>
  <option>BTCUSDT</option>
  <option>ETHUSDT</option>
  <option>SOLUSDT</option>
  <option>SUIUSDT</option>
  <option>XRPUSDT</option>
  <option>NEARUSDT</option>
  <option>CAKEUSDT</option>
  <option>ASTERUSDT</option>
  <option>ADAUSDT</option>
  <option>CRVUSDT</option>
  <option>XLMUSDT</option>
  <option>DOGEUSDT</option>
  <option>TRXUSDT</option>
  <option>PUMPUSDT</option>
  <option>TONUSDT</option>
</select>

<div class="table-container">
<table>
<thead>
<tr>
<th>TF / INDIC</th>
<th>1h</th>
<th>4h</th>
<th>8h</th>
<th>1d</th>
<th>1W</th>
</tr>
</thead>
<tbody id="tableBody">
<tr><td colspan="7">در حال دریافت داده‌ها...</td></tr>
</tbody>
</table>
</div>

<h2>فیبوناچی</h2>

<div class="fibo-tf-selector" id="fiboTfSelector">
  <button data-tf="60m" data-limit="144">1 ساعته (144)</button>
  <button data-tf="4h" data-limit="144" class="active">4 ساعته (144)</button>
  <button data-tf="1d" data-limit="200">روزانه (200)</button>
</div>

<p id="statusFibo">در حال دریافت داده‌ها...</p>

<table id="fiboTable">
<thead>
<tr><th>درصد (%)</th><th>سطح فیبوناچی</th></tr>
</thead>
<tbody id="fiboBody"></tbody>
</table>

<script>
//================ جدول اول (HA + اندیکاتورها) =================
const intervals = ["60m","4h","8h","1d","1W"];
let currentSymbol = document.getElementById('symbolSelect').value;
// متغیر جدید برای نگهداری تایم فریم فیبوناچی انتخاب شده
let currentFiboTF = '4h'; // مقدار پیش‌فرض

// === ابزارهای هشدار جدید ===
let isCrossoverActive = false;
// آدرس یک فایل صوتی که هنگام هشدار پخش می‌شود
const alertSound = new Audio('https://s3.tradingview.com/static/notify/notification.mp3');

// 1. درخواست مجوز اعلان‌ها
function requestNotificationPermission() {
    if ('Notification' in window) {
        if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
            Notification.requestPermission();
        }
    }
}

// 2. هشدار صوتی
function playAudio() {
    try {
        alertSound.currentTime = 0; 
        alertSound.play().catch(e => console.error("Audio playback restricted:", e));
    } catch(e) {
        console.error("Audio playback failed:", e);
    }
}

// 3. لرزش (ویبره)
function vibrateDevice() {
    if ('vibrate' in navigator) {
        // الگوی لرزش: ۲۰۰ میلی‌ثانیه روشن، ۱۰۰ خاموش، ۲۰۰ روشن
        navigator.vibrate([200, 100, 200]);
    }
}

// 4. اعلان دسکتاپ (نوتیفیکیشن)
function sendDesktopNotification(title, body) {
    if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(title, { 
            body: body, 
            icon: 'https://www.google.com/s2/favicons?domain=tradingview.com',
            vibrate: [200, 100, 200]
        });
    }
}

// 5. بررسی کراس باند میانی و اجرای هشدارها
function checkForBollingerCrossoverAlert(currentClose, prevClose, midBand, interval) {
    let alertMessage = null;
    const title = `${currentSymbol} ${interval} - هشدار کراس باند میانی`;

    // 1. کراس به سمت بالا (صعودی): کلوز قبلی زیر باند میانی بود و کلوز فعلی بالای آن است
    const bullishCrossover = (prevClose < midBand) && (currentClose > midBand);
    
    // 2. کراس به سمت پایین (نزولی): کلوز قبلی بالای باند میانی بود و کلوز فعلی زیر آن است
    const bearishCrossover = (prevClose > midBand) && (currentClose < midBand);

    if (midBand === null) return; // اگر باند میانی محاسبه نشده باشد، ادامه نده

    if (bullishCrossover) {
        alertMessage = `⬆️ کراس صعودی: کندل به بالای باند میانی (${midBand.toFixed(5)}) بسته شد.`;
    } else if (bearishCrossover) {
        alertMessage = `⬇️ کراس نزولی: کندل به زیر باند میانی (${midBand.toFixed(5)}) بسته شد.`;
    }

    // اگر شرط هشدار برقرار بود و هشدار فعال دیگری نداشتیم
    if (alertMessage && !isCrossoverActive) {
        isCrossoverActive = true;
        
        // --- اجرای همه هشدارها ---
        playAudio();
        vibrateDevice();
        sendDesktopNotification(title, alertMessage);

        // هشدار بصری روی صفحه
        const statusEl = document.getElementById('crossoverStatus');
        if (statusEl) {
            statusEl.innerHTML = `🚨 **ALERT:** ${alertMessage} 🚨`;
            statusEl.classList.add(bullishCrossover ? 'buy' : 'sell'); // سبز برای صعودی، قرمز برای نزولی
        }
        
        // پس از ۶۰ ثانیه، وضعیت هشدار را ریست می‌کنیم تا هشدارهای جدید فعال شوند
        setTimeout(() => {
            isCrossoverActive = false;
            if (statusEl) {
                statusEl.textContent = '✅ در حال نظارت بر کراس باند میانی بولینگر.';
                statusEl.classList.remove('buy', 'sell');
            }
        }, 60000); 
    }
}
// === پایان ابزارهای هشدار جدید ===


async function fetchPrices(symbol, interval="60m"){
  try{
    // برای محاسبه کراس به دو کندل آخر نیاز داریم، پس limit را حداقل روی 15 می‌گذاریم
    const url=`https://api.mexc.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=200`; 
    const proxy="https://corsproxy.io/?";
    const res=await fetch(proxy+encodeURIComponent(url));
    const data=await res.json();
    return data.map(c=>({time:new Date(c[0]), open:+c[1], high:+c[2], low:+c[3], close:+c[4]}));
  }catch(e){ console.error(e); return null; }
}

function convertHA(data){
  if(!data) return [];
  const ha=[];
  for(let i=0;i<data.length;i++){
    const {open:o,high:h,low:l,close:c}=data[i];
    if(i===0) ha.push({open:(o+c)/2, high:h, low:l, close:(o+h+l+c)/4});
    else{
      const prev=ha[i-1];
      const haClose=(o+h+l+c)/4;
      ha.push({open:(prev.open+prev.close)/2, high:Math.max(h,(prev.open+prev.close)/2,haClose), low:Math.min(l,(prev.open+prev.close)/2,haClose), close:haClose});
    }
  }
  return ha;
}

function calculateEMAArray(values, period){
  if(!values||values.length<period) return Array(values?values.length:0).fill(null);
  const k=2/(period+1), out=[]; let sum=0;
  for(let i=0;i<values.length;i++){
    const v=values[i];
    if(i<period-1){ out.push(null); sum+=v||0; continue; }
    if(i===period-1){ sum+=v||0; out.push(sum/period); continue; }
    const prev=out[i-1]; const val=v==null?prev:v; out.push(val*k + prev*(1-k));
  }
  return out;
}

function calculateMA(values, period){
  if(!values || values.length<period) return [];
  const ma=[];
  for(let i=0;i<values.length;i++){
    if(i<period-1||values[i]==null) ma.push(null);
    else { const slice=values.slice(i-period+1,i+1).filter(v=>v!=null); ma.push(slice.reduce((a,b)=>a+b,0)/slice.length); }
  }
  return ma;
}

function calculateRSI(data, period=14) {
  const closes = data.map(d=>d.close);
  if (closes.length <= period) return Array(closes.length).fill(null);
  let gains=0, losses=0;
  for (let i=1;i<=period;i++){
    const diff=closes[i]-closes[i-1];
    if(diff>=0) gains+=diff; else losses-=diff;
  }
  let avgGain=gains/period, avgLoss=losses/period;
  const rsi = Array(period).fill(null);
  for (let i=period;i<closes.length;i++){
    if(i>period){
      const diff=closes[i]-closes[i-1];
      if(diff>=0){ avgGain=(avgGain*(period-1)+diff)/period; avgLoss=(avgLoss*(period-1)+0)/period;}
      else{ avgGain=(avgGain*(period-1)+0)/period; avgLoss=(avgLoss*(period-1)+(-diff))/period;}
    }
    const rs = avgLoss===0?100:avgGain/avgLoss;
    rsi.push(100-(100/(1+rs)));
  }
  return rsi;
}

function calculateCCI(data, period=14){
  if(!data||data.length<period) return Array(data.length).fill(null);
  const cci=[];
  for(let i=0;i<data.length;i++){
    if(i<period-1){ cci.push(null); continue;}
    const slice=data.slice(i-period+1,i+1);
    const tp=slice.map(d=>(d.high+d.low+d.close)/3);
    const sma=tp.reduce((a,b)=>a+b,0)/period;
    const meanDev=tp.reduce((a,b)=>a+Math.abs(b-sma),0)/period;
    const currentTP=(data[i].high+data[i].low+data[i].close)/3;
    cci.push((currentTP-sma)/(0.015*meanDev));
  }
  return cci;
}

function calculateBollinger(data, period=14){
  if(!data||data.length<period) return {upper:[], mid:[], lower:[]};
  const mid=[]; for(let i=period-1;i<data.length;i++){ const slice=data.slice(i-period+1,i+1).map(d=>d.close); mid.push(slice.reduce((a,b)=>a+b,0)/period);}
  const upper=[], lower=[];
  for(let i=period-1;i<data.length;i++){
    const slice=data.slice(i-period+1,i+1).map(d=>d.close);
    const avg=mid[i-(period-1)];
    const std=Math.sqrt(slice.map(p=>Math.pow(p-avg,2)).reduce((a,b)=>a+b,0)/period);
    upper.push(avg+2*std); lower.push(avg-2*std);
  }
  return {upper, mid, lower};
}

function calculateROC(prices, period=9){
  if(!prices||prices.length<period) return [];
  return prices.map((p,i)=>i<period?null:(p.close-prices[i-period].close)/prices[i-period].close*100);
}

function getTickHtml(cond){ return cond?'<span class="tick green">✔</span>':'<span class="tick red">✘</span>'; }

async function getSymbolData(symbol, interval){
  const raw = await fetchPrices(symbol, interval);
  if(!raw||raw.length===0) return null;
  const ha=convertHA(raw);
  
  // کلوز کندل فعلی و کندل قبلی را از داده خام استخراج می‌کنیم
  const price=raw.at(-1)?.close;
  const prevClose=raw.at(-2)?.close;
  
  const ema7 = raw.length >= 7 ? calculateEMAArray(raw.map(d=>d.close),7) : Array(raw.length).fill(null);

  const boll=ha.length>=14?calculateBollinger(ha):{upper:Array(ha.length).fill(null), mid:Array(ha.length).fill(null), lower:Array(ha.length).fill(null)};
  const rsi=ha.length>=14?calculateRSI(ha):Array(ha.length).fill(null);
  const rsiMA=rsi.length>=14?calculateMA(rsi,14):Array(rsi.length).fill(null);
  const cci=ha.length>=14?calculateCCI(ha):Array(ha.length).fill(null);
  const cciMA=cci.length>=14?calculateMA(cci,14):Array(cci.length).fill(null);
  const roc=ha.length>=9?calculateROC(ha,9):Array(ha.length).fill(null);
  const rocMA=roc.length>=5?calculateMA(roc,5):Array(ha.length).fill(null);
  const prevcci=cci.length>=2?cci.at(-2):null;
  const latest={
    bollUpper:boll.upper.at(-1), bollMid:boll.mid.at(-1), bollLower:boll.lower.at(-1),
    rsi:rsi.at(-1), rsiMA:rsiMA.at(-1),
    cci:cci.at(-1), cciMA:cciMA.at(-1),
    roc:roc.at(-1), rocMA:rocMA.at(-1),
    ema7: ema7.at(-1)
  };
  let buy=false, sell=false;
  if([price, latest.bollMid, latest.rsi, latest.rsiMA, latest.cci].every(v=>v!=null)){
    buy=price>latest.bollMid && latest.rsi>latest.rsiMA && prevcci<0 && latest.cci>0;
    sell=price<latest.bollMid && latest.rsi<latest.rsiMA && prevcci>0 && latest.cci<0;
  }
  // اضافه کردن prevClose برای استفاده در هشدار
  return {...latest, symbol, price, prevClose, buySignal:buy, sellSignal:sell}; 
}

function buildReversedTable(){
  const tbody=document.getElementById('tableBody');
  tbody.innerHTML='';
  const indicators=["price","ema7","bollMid","bollUpper","bollLower","rsi","rsiMA","cci","cciMA","roc","rocMA","signal","tv"];
  for(const ind of indicators){
    const tr=document.createElement('tr');
    tr.id=`row_${ind}`;
    tr.innerHTML=`<td>${ind.toUpperCase()}</td>`+intervals.map(i=>`<td id="${ind}_${i}">—</td>`).join('');
    tbody.appendChild(tr);
  }
}

async function updateReversedTable(){
  for(const interval of intervals){
    const data=await getSymbolData(currentSymbol, interval);
    if(!data) continue;
    
    // --- اجرای بررسی هشدار کراس باند میانی برای تایم‌فریم‌های ۱ و ۴ ساعته ---
    if(interval === '60m' || interval === '4h') { 
        if (data.price && data.prevClose && data.bollMid) {
             checkForBollingerCrossoverAlert(data.price, data.prevClose, data.bollMid, interval);
        }
    }
    // ----------------------------------
    
    const mapData={
      price:data.price?.toFixed(5)??'—',
      ema7: `${data.ema7?.toFixed(5) ?? '—'} ${getTickHtml(data.price>data.ema7)}`,
      bollMid:`${data.bollMid?.toFixed(5)??'—'} ${getTickHtml(data.price>data.bollMid)}`,
      bollUpper:data.bollUpper?.toFixed(5)??'—',
      bollLower:data.bollLower?.toFixed(5)??'—',
      rsi:`${data.rsi?.toFixed(2)??'—'} ${getTickHtml(data.rsi>data.rsiMA)}`,
      rsiMA:data.rsiMA?.toFixed(2)??'—',
      cci:`${data.cci?.toFixed(2)??'—'} ${getTickHtml(data.cci>0)}`,
      cciMA:data.cciMA?.toFixed(2)??'—',
      roc:`${data.roc?.toFixed(2)??'—'} ${getTickHtml(data.roc>data.rocMA)}`,
      rocMA:data.rocMA?.toFixed(2)??'—',
      signal:data.buySignal?'خرید ✅':data.sellSignal?'فروش ❌':'خنثی',
      tv:`<a class="tv" href="https://www.tradingview.com/chart/?symbol=BINANCE:${currentSymbol}" target="_blank">مشاهده</a>`
    };
    for(const key in mapData){
      const td=document.getElementById(`${key}_${interval}`);
      if(td) td.innerHTML=mapData[key];
    }
  }
}

document.getElementById('symbolSelect').addEventListener('change', e=>{
  currentSymbol=e.target.value;
  buildReversedTable();
  updateReversedTable();
  updateFibo();
});

// === اجرای اولیه و درخواست مجوز اعلان‌ها ===
document.addEventListener('DOMContentLoaded', () => {
    requestNotificationPermission();

    buildReversedTable();
    updateReversedTable();
    updateFibo();
});

// به‌روزرسانی خودکار
setInterval(updateReversedTable,30000);

//================ جدول فیبوناچی =================
function getColorByLevel(lvl){
  if(lvl===0.5) return "white";
  if(lvl>0.5){ const t=(lvl-0.5)/0.5; const r=255,g=Math.floor(255-t*155),b=Math.floor(255-t*155); return `rgb(${r},${g},${b})`; }
  else{ const t=lvl/0.5; const r=255,g=Math.floor(255*t),b=0; return `rgb(${r},${g},${b})`; }
}

function createFiboTable(){
  const levels=[0,0.236,0.382,0.5,0.618,0.786,1];
  const tbody=document.getElementById("fiboBody");
  tbody.innerHTML="";
  levels.forEach(lvl=>{
    const tr=document.createElement("tr");
    tr.style.color=getColorByLevel(lvl);
    const td1=document.createElement("td"); td1.textContent=(lvl*100).toFixed(1)+"%";
    const td2=document.createElement("td"); td2.id="lvl_"+lvl.toString().replace(".","_");
    tr.appendChild(td1); tr.appendChild(td2);
    tbody.appendChild(tr);
  });
}

async function updateFibo(){
  const tf = currentFiboTF; // استفاده از متغیر سراسری
  const symbol=document.getElementById("symbolSelect").value;
  let limit=144;
  if(tf==="1d") limit=144;
  
  // به‌روزرسانی نمایش طول دوره
  
  const proxy="https://corsproxy.io/?";
  const url=`https://api.mexc.com/api/v3/klines?symbol=${symbol}&interval=${tf}&limit=${limit}`;
  document.getElementById("statusFibo").textContent="⏳ در حال دریافت داده‌ها...";
  
  try{
    const res=await fetch(proxy+encodeURIComponent(url));
    const data=await res.json();
    if(!Array.isArray(data)||data.length<2) throw new Error("داده کافی یافت نشد");
    const levels=[0,0.236,0.382,0.5,0.618,0.786,1];
    const highsC=data.map(d=>parseFloat(d[2]));
    const lowsC=data.map(d=>parseFloat(d[3]));
    const highC=Math.max(...highsC);
    const lowC=Math.min(...lowsC);
    const diffC=highC-lowC;
    const lastClose=parseFloat(data[data.length-1][4]);
    const prevClose=parseFloat(data[data.length-2][4]);
    
    levels.forEach(lvl=>{
      const price=highC-diffC*lvl;
      let mark="";
      if(prevClose<price && lastClose>price) mark="✅";
      else if(prevClose>price && lastClose<price) mark="❌";
      const td=document.getElementById("lvl_"+lvl.toString().replace(".","_"));
      td.textContent=price.toFixed(6)+" "+mark;
    });
    document.getElementById("statusFibo").textContent=`✅ داده‌ها بروز شدند: ${new Date().toLocaleTimeString()}`;
  }catch(err){
    console.error(err);
    document.getElementById("statusFibo").textContent="❌ خطا در دریافت داده یا محاسبه فیبوناچی.";
  }
}

// === منطق جدید برای دکمه‌های انتخاب تایم‌فریم فیبوناچی ===
const fiboTfSelector = document.getElementById('fiboTfSelector');

fiboTfSelector.addEventListener('click', (e) => {
    if (e.target.tagName === 'BUTTON') {
        const newTf = e.target.getAttribute('data-tf');
        
        // حذف کلاس active از همه دکمه‌ها
        fiboTfSelector.querySelectorAll('button').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // افزودن کلاس active به دکمه کلیک شده
        e.target.classList.add('active');
        
        // به‌روزرسانی متغیر سراسری و اجرای محاسبه
        currentFiboTF = newTf;
        updateFibo();
    }
});
// === پایان منطق جدید ===


createFiboTable();
setInterval(updateFibo,30000); // به روزرسانی خودکار فیبوناچی
</script>
</body>
</html>
